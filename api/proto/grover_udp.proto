syntax = "proto3";

package groverudp.v1;
option go_package = "github.com/jgoldverg/grover/pkg/groverpb/groverudpv1;groverudpv1";

service GroverServer {
  rpc StartServer (StartServerRequest) returns (StartServerResponse);
  rpc StopServer  (StopServerRequest)  returns (StopServerResponse);
  rpc ListPorts (ListPortRequest) returns (ListPortResponse);
  rpc DeleteUdpPorts (DeleteUdpPortsRequest) returns (DeleteUdpPortsResponse);
  rpc CreateUdpPorts (CreateUdpPortsRequest) returns (CreateUdpPortsResponse);
}

service TransferControl {
  rpc OpenSession (OpenSessionRequest) returns (OpenSessionResponse);
  rpc CloseSession (CloseSessionRequest) returns (CloseSessionResponse);
}


message OpenSessionRequest {
  enum Mode {
    MODE_UNSPECIFIED = 0;
    READ  = 1;
    WRITE = 2;
  }

  Mode mode = 1;
  string path = 2;                 // Object path
  int64  size = 3;                 // Used when mode=WRITE; -1 if unknown
  bool   verify_checksum = 4;      // Request checksum in FIN
  uint32 parallel_streams = 5;     // Number of UDP streams client wants
}

message OpenSessionResponse {
  bytes  session_id  = 1;          // 16-byte UUID
  bytes  token       = 2;          // HMACâ€™d cookie for UDP HELO
  string server_host = 3;          // UDP endpoint host
  uint32 server_port = 4;          // UDP port (can be shared across streams)
  repeated uint32 stream_ids = 5;  // One per parallel stream
  uint32 mtu_hint    = 6;
  uint64 total_size  = 7;
  uint32 ttl_seconds = 8;
}

message CloseSessionRequest  { bytes session_id = 1; }
message CloseSessionResponse { bool ok = 1; }




message CreateUdpPortsRequest {
  uint32 port_count = 1;
}

message CreateUdpPortsResponse {
  repeated uint32 ports = 1;
}

message DeleteUdpPortsRequest {
  repeated uint32 port_num = 1;
}

message DeleteUdpPortsResponse {
  bool ok = 1;
}

message ListPortRequest {}

message ListPortResponse {
  repeated uint32 port = 1;
}

message StartServerRequest {
  uint32 udp_port = 1;
  uint32 workers_per_file = 2;
  uint32 max_transfers = 3;
}

message StartServerResponse {
  bool   ok = 1;
  uint32 port = 2;
  string message = 3;
}

message StopServerRequest {}
message StopServerResponse {
  bool   ok = 1;
  string message = 2;
}
