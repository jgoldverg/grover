syntax = "proto3";

package groverudp.v1;
option go_package = "github.com/jgoldverg/grover/pkg/groverpb/groverudpv1;groverudpv1";

service GroverServer {
  rpc StartServer (StartServerRequest) returns (StartServerResponse);
  rpc StopServer  (StopServerRequest)  returns (StopServerResponse);
  rpc ListPorts (ListPortRequest) returns (ListPortResponse);
  rpc DeleteUdpPorts (DeleteUdpPortsRequest) returns (DeleteUdpPortsResponse);
  rpc CreateUdpPorts (CreateUdpPortsRequest) returns (CreateUdpPortsResponse);
}

service TransferControl {
  rpc OpenSession (OpenSessionRequest) returns (OpenSessionResponse);
  rpc CloseSession (CloseSessionRequest) returns (CloseSessionResponse);
  rpc LeaseStream (LeaseStreamRequest) returns (LeaseStreamResponse);
  rpc ReleaseStream (ReleaseStreamRequest) returns (ReleaseStreamResponse);
  rpc EnumeratePath (EnumeratePathRequest) returns (EnumeratePathResponse);
}

enum OverwritePolicy {
  OVERWRITE_UNSPECIFIED = 0;
  OVERWRITE_ALWAYS = 1;
  OVERWRITE_IF_NEWER = 2;
  OVERWRITE_NEVER = 3;
  OVERWRITE_IF_DIFFERENT = 4;
}


message OpenSessionRequest {
  enum Mode {
    MODE_UNSPECIFIED = 0;
    READ  = 1;
    WRITE = 2;
  }

  Mode mode = 1;
  string path = 2;                 // Object path
  int64  size = 3;                 // Used when mode=WRITE; -1 if unknown
  bool   verify_checksum = 4;      // Request checksum in FIN
  uint32 parallel_streams = 5;     // Number of UDP streams client wants
}

message OpenSessionResponse {
  bytes  session_id  = 1;          // 16-byte UUID
  bytes  token       = 2;          // HMACâ€™d cookie for UDP HELO
  string server_host = 3;          // UDP endpoint host
  uint32 server_port = 4;          // UDP port (can be shared across streams)
  repeated uint32 stream_ids = 5;  // One per parallel stream
  uint32 mtu_hint    = 6;
  uint64 total_size  = 7;
  uint32 ttl_seconds = 8;
}

message CloseSessionRequest  { bytes session_id = 1; }
message CloseSessionResponse { bool ok = 1; }

message LeaseStreamRequest {
  bytes session_id = 1;
  OpenSessionRequest.Mode mode = 2;
  string path = 3;
  int64 size = 4;
  bool verify_checksum = 5;
  OverwritePolicy overwrite = 6;
  uint32 preferred_stream_id = 7;
}

message LeaseStreamResponse {
  uint32 stream_id = 1;
  bytes lease_id = 2;
}

message ReleaseStreamRequest {
  bytes session_id = 1;
  uint32 stream_id = 2;
  bytes lease_id = 3;
  bool commit = 4;
  uint64 bytes_transferred = 5;
  string error_message = 6;
}

message ReleaseStreamResponse {
  bool ok = 1;
}

message FileSpec {
  string full_path = 1;
  string relative_path = 2;
  uint64 size = 3;
}

message EnumeratePathRequest {
  string path = 1;
  bool recursive = 2;
}

message EnumeratePathResponse {
  repeated FileSpec files = 1;
}



message CreateUdpPortsRequest {
  uint32 port_count = 1;
}

message CreateUdpPortsResponse {
  repeated uint32 ports = 1;
}

message DeleteUdpPortsRequest {
  repeated uint32 port_num = 1;
}

message DeleteUdpPortsResponse {
  bool ok = 1;
}

message ListPortRequest {}

message ListPortResponse {
  repeated uint32 port = 1;
}

message StartServerRequest {
  uint32 udp_port = 1;
  uint32 workers_per_file = 2;
  uint32 max_transfers = 3;
}

message StartServerResponse {
  bool   ok = 1;
  uint32 port = 2;
  string message = 3;
}

message StopServerRequest {}
message StopServerResponse {
  bool   ok = 1;
  string message = 2;
}
